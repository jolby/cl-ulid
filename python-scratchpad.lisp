(defpackage :ulid-py
  (:use :cl)
  (:export
   #:def-decode-arrary
   #:get-decode-array))

(in-package :ulid-py)

(defun def-decode-arrary ()
  (py4cl2::raw-pyexec "from typing import Sequence")
  (py4cl2::raw-pyexec "DECODE: Sequence[int] = [
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,
0x09,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0xFF,0x12,0x13,
0xFF,0x14,0x15,0xFF,0x16,0x17,0x18,0x19,0x1A,0xFF,0x1B,0x1C,0x1D,0x1E,0x1F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0xFF,0x12,0x13,0xFF,0x14,0x15,0xFF,0x16,0x17,
0x18,0x19,0x1A,0xFF,0x1B,0x1C,0x1D,0x1E,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,]
 ")
(py4cl2::raw-pyexec "print(DECODE)")
(py4cl2::pyeval "DECODE")
  )

(defun get-decode-array ()
  (def-decode-arrary)
  (py4cl2::pyeval "DECODE"))

(defun init-python-ulid ()
   (py4cl2::raw-pyexec "from ulid import base32")
   (py4cl2::raw-pyexec "from ulid import constants")
   (py4cl2::raw-pyexec "from ulid.base32 import encode")
   (py4cl2::raw-pyexec "from ulid.base32 import decode")
 )

(defun ulid-py-encode (bytes)
  (init-python-ulid)
  (let* ((encoded (py4cl2::pycall "encode" bytes)))
    (log:info "encoded: ~a" encoded)
  encoded))

(defun ulid-py-decode (encoded-str)
  (init-python-ulid)
  (let* ((decoded (py4cl2:pycall "decode" encoded-str))
         (byte-list (py4cl2:pycall 'list decoded)))
    byte-list))

;;(ulid-py-encode (crypto:random-data 16))
 ; => "38MR8VZBQG1XHFTW81ACRH192M"
;;(crypto:random-data 16)
 ; => #(17 233 224 250 143 119 25 129 34 14 159 103 252 240 56 182)
;;(ulid-py-encode #(17 233 224 250 143 119 25 129 34 14 159 103 252 240 56 182))
 ; => "0HX7GFN3VQ360J43MZCZYF0E5P"
;;(ulid-py-encode (babel:string-to-octets "0123456789ABCDEF"))
 ; => "1G64S36D1N6RVKGEA1891M8HA6"
;; (ulid-py-decode "38MR8VZBQG1XHFTW81ACRH192M")
;; (ulid-py-decode "0HX7GFN3VQ360J43MZCZYF0E5P")
;; (ulid-py-decode "1G64S36D1N6RVKGEA1891M8HA6")


;; (def-decode-arrary)
;; (py4cl2::raw-pyexec "DECODE")
